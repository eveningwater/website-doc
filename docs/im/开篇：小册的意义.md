# 开篇：小册的意义

## 为什么写这本小册

近几年，在线教育、直播等音视频行业非常火，而它们都有一个共同的特点：核心服务就是通信类系统。而且如今各互联网公司或多或少都有自己的通信系统，比如字节跳动的飞书，阿里的钉钉、鹅厂的微信、平安的快乐平安、boss直聘、智联招聘、脉脉等等太多，就不一一举例了，好像不搞个即时通讯系统都不好意思说自己是技术型公司，不集成一个即时通讯功能App的用户就会飞速流失。就更别提只要是个 ToC 的 App 后台就要有一个客服系统。

但是无论基于 TCP 的通信服务，还是 UDP 协议的音视频服务，它们在高可用、高并发、高性能的要求下的架构与逻辑的复杂性，即使经验丰富的老手想要入门都是很困难的，更别说对网络协议知识还只停留在 TCP 三次握手的初学者，更是望而生畏。

而且随着就业竞争压力的增加，"面试造火箭，工作拧螺丝" 还真不是一句口号，这就要求面试者的基础非常扎实。然而越是底层的基础知识，越是难以理解，但它反而越稳定，掌握了它们，上层技术再怎么变化更新，你也可以快速直击本质。比如：

1. 搞明白了操作系统中的内存管理及缓存原理，就不会认为理解 Redis 的原理有多难了;
2. 搞明白了操作系统中的进程、线程的调度原理和PV原语之类的，就不会认为多线程和同步底层原理有多难了;
3. 搞明白了 TCP/IP 协议是如何在没有中心调度的情况下完成消息的可靠交付，就不会认为在一个封闭的环境中分布式系统达成共识的逻辑有多难了。

搞明白了为什么 IPv6 优点这么多但是过了这么多年还是IPv4的天下，也就不难理解为什么说分时操作系统的原理、网络通信原理、数据结构与算法这些底层知识非常重要了。当然，要搞明白这些底层知识也不容易，你需要大量的学习。但是，亲爱的读者，你学习的这些底层核心知识就是你建高楼时的地基，它会决定你成长的高度和速度！

## 进击的少年~

最近，一个开发的朋友跟我说，他公司有个前端同事在做一个功能，要搞个 Websocket 客户端，但是心跳不会搞，网上也找不到答案，而且连接经常出问题，愁得不行。

再比如说，我有一个前同事在公司做推送系统。就是把华为、小米这类原生的推送服务结合极光这类三方推送服务封装成SDK提供给业务层使用。人很聪明也很努力，跟我说他对长连系统很感兴趣，自己在网上查资料学习，但是要么太过理论，要么就只是一个简单的 Demo，学的很困难也没什么进展。

可以说他们的心情我非常理解，因为我也是这么走过来的，但是我无法三言两语解决他们的问题!

我还深刻记得，几年前，我在一家国内最早的即时通讯云服务提供商公司，带一个小团队并负责整个 Web 后端服务。当时，我们后端的技术栈就是 C++ 和 Java，其中通讯相关的服务就是 C++ 写的，而管理后台和 OpenAPI 等 Web 服务使用 Java 开发。

后来，由于业务上对 Web 版本的需求，我开始使用 netty-socketio 实现一个 Web 端的接入服务并开发了 JavaScript 版 SDK，把原生 App 上发送过来的消息通过这个服务推送到 Web 端。从这开始算是入了长连接服务的坑，入坑之后我经历过一次难忘的线上服务崩溃事故，原因就是内存泄漏只增不减，最后crash，而且线下很难复现，搞了好几天才最终解决，期间只能用脚本定时重启服务，真是流下了没有知识的泪。

> 所有这些问题！究其原因，一些方面是因为通讯类系统有两个特点：

* 其一它是知识密集型系统，首先你至少要搞明白 IO 模型、线程调度、并发锁、GC 等一些基本知识；再深入点你需要把网络协议、操作系统、数据结构这类基础但又底层的知识理解透；这样当你遇到一些边界问题时你就可以通过基本理论来推导出实现逻辑，而不是在网上到处找些没有上下文的"答案"，完工之后再跑通几个测试用例就下定论：搞定！，这就是典型的以偏概全，这往往也是系统上线之后出现问题还不知道如何彻底解决的根源。
* 其二它是逻辑缜密型系统，通常需要客户端与服务端，以及服务与服务之间相互配合来实现一些功能；比如登录退出、异常重连、消息收发、消息确认与重发等逻辑之间环环相扣。而且整个系统消息收发都是异步的，没有全局时钟，很容易出现错误而且还不好定位。

另一方面是因为通信系统的架构与底层框架非常灵活，因此没有实践过的读者自己摸着石头过河，过程会非常坎坷，往往就是走错了方向到最后才醒悟，严重打击自信心。所以我编写这本实战小册，希望通过带读者实现一套即时通讯IM系统。在从简到难，从无到有的这个过程中，帮读者解决如下几个问题：

1. 对网络、IO、多线程、通信协议之类的底层知识有更深的理解。
2. 大多数 Golang 实战类项目比较偏业务，无非就是 Java 中一套框架换成 Golang 的，如果读者想通过这类项目来学习 Golang，很难有多深的理解。但是通过本小册实战内容，你除了可以学习到web服务的知识外，3. 还可以在实战中学习大量 Golang 高级的用法与技巧，写到简历上将会是一个亮点。
4. 掌握高性能、高可用、百万并发以上的通信系统的原理与实现逻辑。
5. 通过实战的 Typescript 版 SDK ，掌握长连服务前端的实现原理与逻辑。

## 小册的核心价值与优势

* 知识与实战深度结合：我相信很多读者都阅读过大量的技术文章，但是第二天可能就记不清了，一周之后就完全忘记了，究其主要原因是因为没有经过自己的过滤与深度思考，但是如果直接看源码难度高效率低。因此本小册将实战项目与小册知识点解读结合，手把手教你如何一步步实现一套即时通讯系统，以及在这个过程中使用到了那些技术，为什么要这么做。

* 完整的生命周期：当你手里拿着锤子时，所有东西看起来都像钉子。本小册虽然是以 IM 这个话题为核心来展开的，但本质上还是在讲如何一步步从 0 到 1 构建一个逻辑复杂的系统。从需求规划，到架构设计，再到技术选型。从抽象逻辑定义，到功能实现，再到测试验收。从集成测试，到部署运维，再到迭代更新！就像诗人 海明威 诗中所写，没有人是一座孤岛，而知识更不是一座孤岛。所以本小册是以点带面，从IM这个典型场景来帮助读者提高自己的综合实力，开扩视野，然后回馈到工作中，四两拨千斤。

* 清晰的系统分层：在实战部分，核心通信系统内部框架组件的设计也是层次分明，职责分明，本小册会从下向上依次展开，但是在讲解具体功能时则是先抽象逻辑，再细节实现，学习起来就像打怪升级一样轻松。

<div class="image-container">
    <img src="./docs/im/images/1.png" alt="图片1-1" title="图片1-1" >
    <span class="image-title">图 1-1 </span>
</div>

* 分阶段规划学习路径：整个实战项目分为多个里程碑，每一个里程碑都有一个可测试的产出，是一个完整的闭环，每完成一个里程碑，项目代码都会打一个 Tag。而且为了加深读者的理解，我会把复杂的逻辑尽量简单实现，然后在后面章节再优化。通过这样阶段化的学习，其一是降低读者实战练习的难度；其二是通过对比学习思考，让读者知其所以然！。这也就是我花大量精力重新设计与规划，从零开始编码本小册实战项目的意义了。比如第一个[里程碑v1.1](https://github.com/klintcheng/kim/releases/tag/v1.1)。

<div class="image-container">
    <img src="./docs/im/images/2.png" alt="图片1-2" title="图片1-2" >
    <span class="image-title">图 1-2 </span>
</div>

## 小册进阶指南

<div class="image-container">
    <img src="./docs/im/images/3.png" alt="图片1-3" title="图片1-3" >
    <span class="image-title">图 1-3 </span>
</div>

整个小册会从基础篇、架构篇、实战篇，进阶篇四个大的主题来讲解，从基础开始，帮助读者打通任督二脉，掌握降龙十八掌，最后一起华山论剑。

一、基础篇：练内功

1. Demo实战：通过编写一个Demo示例来演示一个最简化的聊天系统是如何实现的，方便读者与之后的实战部分逻辑做对比，加深理解。
2. 可靠连接及实战：介绍实现可靠连接的知识及原理；并使用typescript完成一个简单的示例，实现登录退出、心跳及自动重连等逻辑。
3. 网络协议：分两章介绍TCP/IP五层协议内容，从抽象到具体讲解网络中数据包是如何被交付，帮助读者在大脑中构建一个初步的网络知识体系；它是我对《TCP/IP详解 卷1：协议》第二版一书的浓缩与加工的结果。

二、架构篇：打通任督二脉

1. 分布式架构及演进: 介绍单体架构到集群架构再到分布式高可用架构演进过程及它们的优缺点。
2. 系统架构与通讯协议：介绍系统的架构设计与通讯协议的设计及原理。
3. 通信层框架设计：通过抽象通信层，实现多协议(websocket/tcp等)逻辑复用，与业务逻辑解耦。

三、实战篇：降龙十八掌

1. 构建系统底层框架。
2. 登录、单聊、群聊等逻辑实现。
3. 使用TS开发Web版本SDK。

> 实战部分都是先讲原理，再讲核心流程代码，大量配图哈。

四、进阶篇：华山论剑

1. 性能优化篇：介绍从内存、IO、缓冲、GC等一些方面来优化系统性能，然后通过基准测试和压力测试来验证效果。
2. 灰度发布：介绍IM系统中如何设计实现灰度发布功能。
3. 部署架构：介绍IM系统部署架构，系统数据中心容灾架构要点及解决方案，如何实现主备架构和双活架构。

## 写给读者

* 虽然本小册尽量讲得通俗易懂，但是我也没想着拿文档或者基础知识来灌水，因此需要读者有点开发经验，看的懂Golang或Typescript的代码逻辑，有一些 Web 服务方面的基本知识。

* 基于用户就是上帝这个原则，我对小册每章图片内容与文字排版要求很高，因此你可以在地铁上或带薪如厕时掏出手机学习充电。当然在电脑上阅读更佳，毕竟还有代码块，在手机上阅读会受影响！

* 致JAVA方向的读者，在如今这个云原生的时代，JVM平台可移植性的优势已经不复存在，反而它带来的性能损耗成了缺点。而Golang则是一种高性能的云原生语言，因此如果你也正在学习Golang，何不通过本小册学习一下，而且通过深入了解Golang的特性再与JAVA中的线程、内存模型、GC等原理作对比，相信你对Java也会有更深入的理解，跳出能力圈也许你可以成长更快。

* 输出是非常好的学习打开方式，而且实战项目的意义在于读者可以跟着代码与小册练习，因此鼓励你从github下载项目到本地，动手实践。

## 开源地址

<div class="image-container">
    <img src="./docs/im/images/4.png" alt="图片1-4" title="图片1-4" >
    <span class="image-title">图 1-4 </span>
</div>

实战项目:

* Golang分布式服务： [King IM Cloud](https://github.com/klintcheng/kim)。
* Web SDK： [Typescript SDK](https://github.com/klintcheng/kim_web_sdk)。

欢迎Star~

接下来，就让我们进入IM的世界吧~