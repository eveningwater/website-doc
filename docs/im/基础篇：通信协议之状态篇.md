# 基础篇：通信协议之状态篇

在上一章节，我们实现了一个聊天demo，其中就使用了websocket协议，它是基于TCP协议的应用层协议，可能有些读者对它了解不深，因此我认为有必要来了解一些网络协议相关的基础知识，理解数据包交付的过程，同时也为了帮助读者理解之后两个章节中可靠连接相关内容打下基础。

<div class="image-container">
    <img src="./docs/im/images/16.png" alt="图片4-1" title="图片4-1" >
    <span class="image-title">图 4-1 </span>
</div>

> 如果读者对此非常了解可以跳过!

## 一图搞懂网络知识

<div class="image-container">
    <img src="./docs/im/images/17.png" alt="图片4-2" title="图片4-2" >
    <span class="image-title">图 4-2 </span>
</div>

这张图信息量有点大，基本覆盖了TCP/IP网络通信各方面的知识点。核心内容如下：

1. 协议层：应用层、传输层、网络层、链路层和物理层。
2. 物理设备：主机、网卡、路由器、交换机、光纤和电缆。
3. 涉及协议：TCP协议、IPv4协议、Ethernet协议。
4. 数据格式：应用数据包、TCP数据包、IP数据包、以太数据包、数字信号和模拟信号。
5. 协议分层中的数据的封包与拆包。
6. NAT网关之IP地址转换。
7. ARP地址转换协议。

> 内容看似很多，我们从状态与行为这两个角度来一点点了解就不是很难了，这里看不懂没关系，理解了下面两章的内容，回过头来再看它。

## 复用、分解和封装

分层体系结构的一个主要优点是具有协议复用的能力，这与我们在编码时的分层复用类似。以下图TCP/IP协议层为例，分别是应用层、传输层、网络层、链路层和物理层。每一层作用与逻辑不同，而且不同层的协议是被不同的硬件和程序操作，比如路由器会解析网络层IP数据包的协议头，得到目的地IP地址。

<div class="image-container">
    <img src="./docs/im/images/18.png" alt="图片4-3" title="图片4-3" >
    <span class="image-title">图 4-3 </span>
</div>

而协议层中的分解和封装就是当发送方从最上层发送数据时，每向下走一层，数据包就会封装一次，加上协议头，上层的数据包就成了当前协议的消息体，协议头是协议能力及逻辑的状态呈现。而在接收方，二进制数据从物理层开始，每向上走一次，就会拆封一次，与封装过程相反，就像剥洋葱。

<div class="image-container">
    <img src="./docs/im/images/19.png" alt="图片4-4" title="图片4-4" >
    <span class="image-title">图 4-4 </span>
</div>

上图就是一个协议的分解过程，每个分层都有很多不同的协议，它们作用不同。而子级协议就拥有父级协议的能力。而本小册的故事就是从它的其中一个分支(蓝色虚线)开始的。

> QUIC它是基于UDP协议的实现，解决了TCP协议的很多不足之处。同时它是HTTP/3.0的底层实现。但是越是底层的技术，越是难以替换，就像IPV6出来这么多年还是无法普及。

## 协议的作用及定义

我们从下往上，分别介绍Ethernet协议、IP协议、TCP协议、Webscoket协议。

### 链路层之以太协议

以太网（Ethernet）是一种计算机局域网技术，也就是说以太网协议只能在局域网的范围内通信。如今在提高的网络速度和使用效率最大化情况下为了减少冲突，已经不再使用总线拓扑结构。而是使用交换机来进行网络连接和组织。这就是我们常说的星型拓扑结构。

<div class="image-container">
    <img src="./docs/im/images/20.png" alt="图片4-5" title="图片4-5" >
    <span class="image-title">图 4-5 </span>
</div>

以太网帧格式如下：

<div class="image-container">
    <img src="./docs/im/images/21.png" alt="图片4-6" title="图片4-6" >
    <span class="image-title">图 4-6 </span>
</div>

可以看到有MAC Destination（目标MAC）和MAC Sourcce（源MAC）两个地址，此外还有一个重要的属性就是32位的CRC校验信息，也就是说以太网协议在一定程度上是可以校验出数据是否错误的。而payload数据包最小46，最大1500字节，通常网卡MTU（最大传输单元）就是1500字节。

> MAC（Media Access Control， 介质访问控制）地址，也叫硬件地址，长度是6字节，由16进制的数字组成，分为前24位和后24位：
> 1. 前24位叫做组织唯一标志符是由IEEE的注册管理机构给不同厂家分配的代码，区分了不同的厂家。
> 2. 后24位是由厂家自己分配的，称为扩展标识符。同一个厂家生产的网卡中MAC地址后24位是不同的。

### 网络层之IPv4/IPv6

IPv4(Internet Protocol version 4)在IETF于1981年9月发布的 RFC791 中被描述。IP提供了一种尽力而为、无连接的数据报交付服务。即它不保证任何数据包均能送达目的地，也不保证所有数据包均按照正确的顺序无重复地到达。比如，一台路由器由于临时用尽缓冲区，达到的IP数据包就无法写入，从而被丢弃，IP协议不会重传。

> IP地址分为三种：(1)单播地址 (2)广播地址 (3)多播地址。

1. 广播和多播仅应用于UDP，比如我们在后面要说的ARP协议。
2. TCP是一个“面向连接”的协议，因此它是基于单播地址而言的。

我们看下IPv4数据包格式：

```css
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                  Example Internet Datagram Header
```

IPv4协议中也定义了源地址(Source Address)和目标地址(Destination Address)。以太网协议局限于局域网，而IP协议通过子网的划分及路由表等逻辑突破了局域网的限制，因此它是TCP/IP协议中最重要的协议之一。

总结下它的重点：

1. Total Length：为16bits，也就是IPv4一个报文最大65,535字节。
2. TTL(Time to Live)：设置了一个数据报可经过的路由器上限，路由器转发时减1，到0就丢弃报文。
3. Protocol：通常有两种17(UDP)和6（TCP)。
4. Header Checksum：只检测IP头数据完整性，不检查数据报中的有效载荷(如TCP数据包)。

### 传输层之TCP

传输控制协议（Transmission Control Protocol，缩写：TCP）是一种面向连接的、可靠的、基于字节流的传输层通信协议，由IETF的RFC 793定义。

```diff
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

TCP协议中定义了两个关健属性源端口(Sourcce Port)与目标端口(Destination Port)，可以从图中看出，端口所占的长度都是16位，也就是最大2^16-1 = 65,535个端口。仅IP地址不足以运行网络应用程序，因为计算机可以运行多个应用程序或服务。 因此，在操作系统层通过端口来区分应用程序。

> 在协议分解那第图中，操作系统可感知的协议到达TCP协议之后就终止，通过端口号的分解，上层的应用程序来决定接收之后的数据包格式。

通常我们所说的长连服务就是基于TCP协议的通信，操作系统通过解析数据包中的tcp协议头，就知道了接收方属于那一个应用程序了。

TCP协议有如下特点：

1. 连接性 - 生命周期、双向缓冲。
2. 可靠性 - ACK、超时重传、拥塞控制等。
3. 字节流 - 粘包、解包。

> TCP协议也是网上文章最多的，这里就不再过多重复说明!

### 应用层之WebSocket

应用层是离我们最近的协议层，比如我们服务中最常使用的HTTP、WebSocket等协议。本小册中会使用到WebSocket来开发接入网关，因此，我们用它来说明应用层协议。

WebSocket是一种网络传输协议，可在单个TCP连接上进行全双工通信，WebSocket使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在WebSocket API中，浏览器和服务器只需要完成一次握手，两者之间就可以建立持久性的连接，并进行双向数据传输。WebSocket是为了在浏览器中使用长连接而定义的协议。因此，它是在http超文本传输协议的基础上升级而来，在协议的分解图中，我们已经看到了Http和WebSocket协议都是基于TCP协议的。

来自客户端的握手如下所示：

```http
GET /chat HTTP/1.1
Host: server.example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Origin: http://example.com
Sec-WebSocket-Protocol: chat, superchat
Sec-WebSocket-Version: 13
```

来自服务器的握手如下所示:

```http
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
Sec-WebSocket-Protocol: chat
```

大致意思就是告诉服务器，我要升级为websocket长连，如果服务器同意，就必须返回101状态，告诉客户端，升级成功。

> 服务器不可返回200这个状态码

WebSocket协议的格式如下：

```lua
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-------+-+-------------+-------------------------------+
|F|R|R|R| opcode|M| Payload len |    Extended payload length    |
|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
|N|V|V|V|       |S|             |   (if payload len==126/127)   |
| |1|2|3|       |K|             |                               |
+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
|     Extended payload length continued, if payload len == 127  |
+ - - - - - - - - - - - - - - - +-------------------------------+
|                               |Masking-key, if MASK set to 1  |
+-------------------------------+-------------------------------+
| Masking-key (continued)       |          Payload Data         |
+-------------------------------- - - - - - - - - - - - - - - - +
:                     Payload Data continued ...                :
+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
|                     Payload Data continued ...                |
+---------------------------------------------------------------+
```

特点：

1. 全双工通信。
2. Websocket与HTTP和HTTPS使用相同的TCP端口，可以绕过大多数防火墙的限制。
3. Websocket协议使用80端口；运行在TLS之上时，默认使用443端口。
4. 协议头大小可变，节省空间。
5. opcode：自带心跳ping/pong协议码。

相比TCP缺点：

1. 增加了协议头，对流量有一点影响。
2. 客户端发送数据载体时必须做一个编码(MASK=1)，这会增加cpu负载。
3. 服务端解析HTTP Upgrade头会增加消耗。

## 网卡、路由器和交换机的作用

### 网卡

网卡或局域网接收器，是一块被设计用来允许计算机在计算机网络上进行通讯的计算机硬件。网卡上面装有处理器和存储器（包括RAM和ROM）。网卡与局域网之间的通信是通过电缆以串行传输方式进行的。而网卡与计算机之间的通信则是通过计算机主板上的I/O总线以并行传输方式进行。

它有如下特点：

1. 每个网卡都拥有一个MAC地址。
2. 它属于TCP/IP协议层中第2层。
3. 它实现了以太网协议。
4. 它有存储器，缓冲以太帧。

### 交换机

网络交换机（Network switch）是一种网络硬件，通过报文交换接收和转发数据到目标设备，它能够在计算机网络上连接不同的设备。一般也简称为交换机。

交换机按功能划分，可以分为一、二、三、四和七层（根据OSI七层协议来划分）交换机。比如第一层交换机不控制数量，任何进入端口数据包会被转发到除进入端口之外的其他所有端口。而本文所指的就是第二层交换机。

它有如下特点：

1. 二层交换机依据硬件地址(MAC地址)传送网络帧。
2. 它自动学习并在内存中维护MAC地址与端口的映射表。

### 路由器

路由器是连接两个以上不同网络的设备。提供路由与转发两种重要机制，可以决定数据包从来源端到目的端所经过的路径!

它有如下特点：

1. 路由器处理第3层网络层，它会解析IP数据包。
2. 实现IP、TCP、UDP、ICMP等网络的协议。
3. 对数据进行处理。收发数据包，具有对数据的分组过滤、复用、加密、压缩及防护墙等各项功能。
4. 依据路由表的信息，对数据包下一传输目的地进行选择。
5. 实现网络管理和系统支持功能。

## 最后总结

可能有些读者看的有点晕哈！实际上本章想表达的核心，就是在通信的过程中，会涉及到了很多的协议，每种协议都有它的逻辑与数据格式，这与人类沟通的语言类似。所有接入互联网中的设备正是通过这些协议，来达成基本共识，才有相互通信的可能。而在下一个章节中，我们来讲解信息是如何从一台主机交付到另一台主机的。

本章完！

1. [参考【rfc791 Internet Protocol】](https://tools.ietf.org/html/rfc791)。
2. [参考【rfc793 Transmission Control Protocol】](https://tools.ietf.org/html/rfc793)。
3. [参考【rfc6455 The WebSocket Protocol】](https://tools.ietf.org/html/rfc6455)。